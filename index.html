<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Contabilità Professionale - Completa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #f5f5f7; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { background: white; border-radius: 16px; padding: 15px 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-size: 1.6rem; display: flex; align-items: center; gap: 10px; }
        .header h1 i { color: #007aff; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 12px 20px; background: white; border-radius: 10px; cursor: pointer; font-weight: 500; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s; }
        .tab:hover { background: #f0f0ff; }
        .tab.active { background: #007aff; color: white; }
        
        .section { background: white; border-radius: 20px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section h2 { margin-bottom: 20px; display: flex; align-items: center; gap: 10px; font-size: 1.4rem; }
        .section h2 i { color: #007aff; }
        
        .sub-tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; border-bottom: 2px solid #e5e5ea; padding-bottom: 10px; }
        .sub-tab { padding: 8px 16px; background: #f8f8fa; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .sub-tab:hover { background: #e5e5ea; }
        .sub-tab.active { background: #007aff; color: white; }
        .sub-section { display: none; }
        .sub-section.active { display: block; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: 500; color: #1c1c1e; font-size: 0.9rem; }
        .form-control { padding: 12px 15px; border: 1px solid #c6c6c8; border-radius: 10px; font-size: 1rem; transition: border 0.2s; }
        .form-control:focus { outline: none; border-color: #007aff; }
        select.form-control { background: white; }
        
        .btn { background: #007aff; color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; display: inline-block; font-size: 1rem; transition: background 0.2s; }
        .btn:hover { background: #005bbf; }
        .btn-secondary { background: #8e8e93; }
        .btn-secondary:hover { background: #6c6c70; }
        .btn-success { background: #34c759; }
        .btn-success:hover { background: #2b9a48; }
        .btn-danger { background: #ff3b30; }
        .btn-danger:hover { background: #d6302a; }
        .btn-warning { background: #ff9500; }
        .btn-warning:hover { background: #e68600; }
        
        .import-card { background: #f8f8fa; border-radius: 16px; padding: 25px; text-align: center; border: 2px dashed #c6c6c8; margin-bottom: 20px; }
        .import-card i { font-size: 40px; color: #007aff; margin-bottom: 15px; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f8f8fa; border-bottom: 2px solid #c6c6c8; font-weight: 600; color: #8e8e93; font-size: 0.9rem; }
        td { padding: 12px; border-bottom: 1px solid #e5e5ea; font-size: 0.95rem; }
        .empty-state { text-align: center; color: #8e8e93; padding: 40px; font-style: italic; }
        
        .badge-success, .badge-warning, .badge-info, .badge-danger { padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
        .badge-success { background: rgba(52,199,89,0.2); color: #34c759; }
        .badge-warning { background: rgba(255,149,0,0.2); color: #ff9500; }
        .badge-info { background: rgba(0,122,255,0.2); color: #007aff; }
        .badge-danger { background: rgba(255,59,48,0.2); color: #ff3b30; }
        
        .flex { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        
        /* PIANO DEI CONTI */
        .conti-livelli { display: flex; flex-direction: column; gap: 20px; }
        .sezione { background: #f8f8fa; border-radius: 16px; padding: 20px; border-left: 8px solid; }
        .sezione[data-sezione="attivo"] { border-left-color: #34c759; }
        .sezione[data-sezione="passivo"] { border-left-color: #ff9500; }
        .sezione[data-sezione="patrimonioNetto"] { border-left-color: #5856d6; }
        .sezione[data-sezione="costi"] { border-left-color: #ff3b30; }
        .sezione[data-sezione="ricavi"] { border-left-color: #007aff; }
        
        .sezione-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(0,0,0,0.1); }
        .sezione-titolo { display: flex; align-items: center; gap: 15px; }
        .sezione-titolo h3 { font-size: 1.4rem; font-weight: 600; }
        .sezione-codice { background: #1c1c1e; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; }
        .sezione-totale { font-size: 1.2rem; font-weight: 700; }
        
        .categorie-container { display: flex; flex-direction: column; gap: 15px; margin-left: 20px; }
        .categoria { background: white; border-radius: 12px; padding: 15px; }
        .categoria-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e5e5ea; }
        .categoria-info { display: flex; align-items: center; gap: 10px; }
        .categoria-info h4 { font-size: 1.2rem; font-weight: 600; }
        .categoria-codice { background: #007aff; color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.9rem; }
        
        .sottocategorie-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px; margin-left: 20px; }
        .sottocategoria { background: #f8f8fa; border-radius: 10px; padding: 12px; }
        .sottocategoria-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px solid #c6c6c8; }
        .sottocategoria-info { display: flex; align-items: center; gap: 8px; }
        .sottocategoria-info h5 { font-size: 1rem; font-weight: 500; }
        .sottocategoria-codice { background: #8e8e93; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; }
        
        .conti-lista { list-style: none; margin-top: 8px; }
        .conti-lista li { padding: 6px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e5ea; }
        .conti-lista li:last-child { border-bottom: none; }
        .conto-info { display: flex; align-items: center; gap: 8px; flex: 1; }
        .conto-codice { color: #8e8e93; font-size: 0.8rem; font-family: monospace; min-width: 70px; }
        .conto-nome { font-size: 0.9rem; flex: 1; }
        .conto-valore { font-weight: 600; min-width: 90px; text-align: right; }
        .edit-conto { color: #8e8e93; cursor: pointer; margin-left: 8px; font-size: 0.9rem; transition: color 0.2s; }
        .edit-conto:hover { color: #007aff; }
        
        .report-periodo { display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap; }
        .partita { border-left: 4px solid #ff9500; background: #fff8f0; }
        .partita-pagata { border-left: 4px solid #34c759; background: #f0fff0; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; }
            .sottocategorie-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-calculator"></i> Contabilità Professionale Completa</h1>
            <span style="color: #34c759;"><i class="fas fa-circle"></i> Online</span>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="cambiaTab('dashboard')">Dashboard</div>
            <div class="tab" onclick="cambiaTab('conti')">Piano dei Conti</div>
            <div class="tab" onclick="cambiaTab('passive')">Fatture Passive</div>
            <div class="tab" onclick="cambiaTab('attive')">Fatture Attive</div>
            <div class="tab" onclick="cambiaTab('coge')">Contabilità Generale</div>
            <div class="tab" onclick="cambiaTab('iva')">Liquidazione IVA</div>
            <div class="tab" onclick="cambiaTab('bancario')">Importazioni Bancarie</div>
            <div class="tab" onclick="cambiaTab('bilancio')">Bilancio</div>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard-view" class="section">
            <h2><i class="fas fa-home"></i> Dashboard</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div style="background: #f8f8fa; padding: 20px; border-radius: 16px;">
                    <h3 style="margin-bottom: 15px;">Situazione Patrimoniale</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span>Totale Attivo:</span><strong id="dashboardAttivo">€ 0,00</strong></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span>Totale Passivo:</span><strong id="dashboardPassivo">€ 0,00</strong></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span>Patrimonio Netto:</span><strong id="dashboardNetto">€ 0,00</strong></div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #c6c6c8;"><span id="dashboardQuadra">⚖️ In quadratura</span></div>
                </div>
                <div style="background: #f8f8fa; padding: 20px; border-radius: 16px;">
                    <h3 style="margin-bottom: 15px;">Situazione IVA</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span>IVA su vendite:</span><strong id="dashboardIvaVendite">€ 0,00</strong></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span>IVA su acquisti:</span><strong id="dashboardIvaAcquisti">€ 0,00</strong></div>
                    <div style="display: flex; justify-content: space-between; font-weight: 600;"><span>IVA a debito/credito:</span><strong id="dashboardIvaNetto">€ 0,00</strong></div>
                </div>
                <div style="background: #f8f8fa; padding: 20px; border-radius: 16px;">
                    <h3 style="margin-bottom: 15px;">Partite Aperte</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span>Clienti:</span><strong id="dashboardClientiAperti">€ 0,00</strong></div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;"><span>Fornitori:</span><strong id="dashboardFornitoriAperti">€ 0,00</strong></div>
                </div>
            </div>
        </div>

        <!-- PIANO DEI CONTI -->
        <div id="conti-view" class="section" style="display: none;">
            <h2><i class="fas fa-sitemap"></i> Piano dei Conti a 4 Livelli</h2>
            
            <div class="flex" style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="mostraModal('categoria')"><i class="fas fa-plus"></i> Nuova Categoria</button>
                <button class="btn btn-success" onclick="mostraModal('sottocategoria')"><i class="fas fa-plus"></i> Nuova Sottocategoria</button>
                <button class="btn btn-success" onclick="mostraModal('conto')"><i class="fas fa-plus"></i> Nuovo Conto</button>
                <button class="btn btn-secondary" onclick="resetContiDefault()"><i class="fas fa-undo"></i> Reset Default</button>
            </div>
            
            <div class="conti-livelli" id="pianoContiContainer"></div>
            
            <div style="margin-top: 20px; padding: 15px; background: #e5f3ff; border-radius: 10px; text-align: center;">
                <strong>Stato Patrimoniale:</strong> Attività <span id="spAttivita">€ 0,00</span> = Passività <span id="spPassivita">€ 0,00</span> + Patrimonio Netto <span id="spNetto">€ 0,00</span>
                <span id="quadratura" style="margin-left: 10px;">⚖️ In quadratura</span>
            </div>
        </div>

        <!-- FATTURE PASSIVE -->
        <div id="passive-view" class="section" style="display: none;">
            <h2><i class="fas fa-file-invoice"></i> Fatture Passive (Acquisti)</h2>
            
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="cambiaSubTab('passive', 'inserimento')">Inserimento Manuale</div>
                <div class="sub-tab" onclick="cambiaSubTab('passive', 'import')">Importa XML</div>
                <div class="sub-tab" onclick="cambiaSubTab('passive', 'lista')">Elenco Fatture</div>
            </div>
            
            <!-- Inserimento Manuale -->
            <div id="passive-inserimento" class="sub-section active">
                <div class="form-grid">
                    <div class="form-group"><label>Numero *</label><input type="text" id="passNumero" class="form-control"></div>
                    <div class="form-group"><label>Data *</label><input type="date" id="passData" class="form-control"></div>
                    <div class="form-group"><label>Fornitore *</label><input type="text" id="passFornitore" class="form-control"></div>
                    <div class="form-group"><label>Partita IVA *</label><input type="text" id="passPiva" class="form-control" onchange="cercaFornitoreDaPiva()"></div>
                    <div class="form-group"><label>Codice Fiscale</label><input type="text" id="passCf" class="form-control" onchange="cercaFornitoreDaCf()"></div>
                    <div class="form-group"><label>Imponibile (€) *</label><input type="number" id="passImponibile" class="form-control" step="0.01"></div>
                    <div class="form-group"><label>Aliquota IVA %</label><select id="passAliquota" class="form-control"><option value="22">22%</option><option value="10">10%</option><option value="5">5%</option><option value="4">4%</option></select></div>
                    <div class="form-group"><label>Conto di Costo *</label><select id="passConto" class="form-control"></select></div>
                </div>
                
                <div id="passFornitoreEsistente" style="display: none; margin-bottom: 15px; padding: 10px; background: #e5f3ff; border-radius: 8px;">
                    <i class="fas fa-info-circle"></i> Fornitore già esistente: <span id="passFornitoreNome"></span>
                </div>
                
                <div class="flex">
                    <button class="btn btn-success" onclick="inserisciFatturaPassiva()"><i class="fas fa-save"></i> Salva Fattura</button>
                    <button class="btn btn-secondary" onclick="resetFormPassiva()"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </div>
            
            <!-- Import XML -->
            <div id="passive-import" class="sub-section">
                <div class="import-card">
                    <i class="fas fa-file-code"></i>
                    <p>Seleziona un file XML di fattura elettronica</p>
                    <input type="file" id="passXmlInput" accept=".xml" style="display: none;" onchange="handleXMLPassive(this.files[0])">
                    <button class="btn" onclick="document.getElementById('passXmlInput').click()"><i class="fas fa-upload"></i> Seleziona XML</button>
                    <div id="passXmlPreview" class="preview-area">Nessun file selezionato</div>
                </div>
                
                <div id="passXmlDettaglio" style="display: none;">
                    <div style="background: #f8f8fa; padding: 20px; border-radius: 16px;">
                        <h4>Dettaglio fattura</h4>
                        <div id="passXmlContenuto"></div>
                        <div id="passXmlFornitoreInfo" style="margin-top: 10px; padding: 10px; background: #e5f3ff; border-radius: 8px;"></div>
                        <div style="margin-top: 15px;"><h5>Seleziona conti di costo:</h5><div id="passXmlLinee"></div></div>
                        <div class="flex" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="confermaImportXMLPassive()">Conferma</button>
                            <button class="btn btn-secondary" onclick="annullaImportXMLPassive()">Annulla</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Elenco Fatture -->
            <div id="passive-lista" class="sub-section">
                <table>
                    <thead><tr><th>Data</th><th>Fornitore</th><th>P.IVA</th><th>Imponibile</th><th>IVA</th><th>Totale</th><th>Stato</th><th>Azioni</th></tr></thead>
                    <tbody id="tabellaFatturePassive"></tbody>
                </table>
            </div>
        </div>

        <!-- FATTURE ATTIVE -->
        <div id="attive-view" class="section" style="display: none;">
            <h2><i class="fas fa-file-invoice"></i> Fatture Attive (Vendite)</h2>
            
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="cambiaSubTab('attive', 'inserimento')">Inserimento Manuale</div>
                <div class="sub-tab" onclick="cambiaSubTab('attive', 'import')">Importa XML</div>
                <div class="sub-tab" onclick="cambiaSubTab('attive', 'lista')">Elenco Fatture</div>
            </div>
            
            <!-- Inserimento Manuale -->
            <div id="attive-inserimento" class="sub-section active">
                <div class="form-grid">
                    <div class="form-group"><label>Numero *</label><input type="text" id="attNumero" class="form-control"></div>
                    <div class="form-group"><label>Data *</label><input type="date" id="attData" class="form-control"></div>
                    <div class="form-group"><label>Cliente *</label><input type="text" id="attCliente" class="form-control"></div>
                    <div class="form-group"><label>Partita IVA</label><input type="text" id="attPiva" class="form-control"></div>
                    <div class="form-group"><label>Imponibile (€) *</label><input type="number" id="attImponibile" class="form-control" step="0.01"></div>
                    <div class="form-group"><label>Aliquota IVA %</label><select id="attAliquota" class="form-control"><option value="22">22%</option><option value="10">10%</option><option value="5">5%</option><option value="4">4%</option></select></div>
                    <div class="form-group"><label>Conto di Ricavo *</label><select id="attConto" class="form-control"></select></div>
                </div>
                <div class="flex">
                    <button class="btn btn-success" onclick="inserisciFatturaAttiva()"><i class="fas fa-save"></i> Salva Fattura</button>
                    <button class="btn btn-secondary" onclick="resetFormAttiva()"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </div>
            
            <!-- Import XML -->
            <div id="attive-import" class="sub-section">
                <div class="import-card">
                    <i class="fas fa-file-code"></i>
                    <p>Seleziona un file XML di fattura elettronica</p>
                    <input type="file" id="attXmlInput" accept=".xml" style="display: none;" onchange="handleXMLAttive(this.files[0])">
                    <button class="btn" onclick="document.getElementById('attXmlInput').click()"><i class="fas fa-upload"></i> Seleziona XML</button>
                    <div id="attXmlPreview" class="preview-area">Nessun file selezionato</div>
                </div>
                
                <div id="attXmlDettaglio" style="display: none;">
                    <div style="background: #f8f8fa; padding: 20px; border-radius: 16px;">
                        <h4>Dettaglio fattura</h4>
                        <div id="attXmlContenuto"></div>
                        <div style="margin-top: 15px;"><h5>Seleziona conti di ricavo:</h5><div id="attXmlLinee"></div></div>
                        <div class="flex" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="confermaImportXMLAttive()">Conferma</button>
                            <button class="btn btn-secondary" onclick="annullaImportXMLAttive()">Annulla</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Elenco Fatture -->
            <div id="attive-lista" class="sub-section">
                <table>
                    <thead><tr><th>Data</th><th>Cliente</th><th>P.IVA</th><th>Imponibile</th><th>IVA</th><th>Totale</th><th>Stato</th><th>Azioni</th></tr></thead>
                    <tbody id="tabellaFattureAttive"></tbody>
                </table>
            </div>
        </div>

        <!-- CONTABILITÀ GENERALE -->
        <div id="coge-view" class="section" style="display: none;">
            <h2><i class="fas fa-book"></i> Contabilità Generale</h2>
            
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="cambiaSubTab('coge', 'inserimento')">Inserimento Manuale</div>
                <div class="sub-tab" onclick="cambiaSubTab('coge', 'import')">Importa Excel</div>
                <div class="sub-tab" onclick="cambiaSubTab('coge', 'lista')">Elenco Scritture</div>
            </div>
            
            <!-- Inserimento Manuale -->
            <div id="coge-inserimento" class="sub-section active">
                <div class="form-grid">
                    <div class="form-group"><label>Data *</label><input type="date" id="cogeData" class="form-control"></div>
                    <div class="form-group"><label>Descrizione *</label><input type="text" id="cogeDescrizione" class="form-control"></div>
                    <div class="form-group"><label>Conto Dare *</label><select id="cogeDare" class="form-control"></select></div>
                    <div class="form-group"><label>Conto Avere *</label><select id="cogeAvere" class="form-control"></select></div>
                    <div class="form-group"><label>Importo (€) *</label><input type="number" id="cogeImporto" class="form-control" step="0.01"></div>
                </div>
                <div class="flex">
                    <button class="btn btn-success" onclick="inserisciScritturaCOGE()"><i class="fas fa-save"></i> Salva Scrittura</button>
                    <button class="btn btn-secondary" onclick="resetFormCOGE()"><i class="fas fa-undo"></i> Reset</button>
                </div>
            </div>
            
            <!-- Import Excel -->
            <div id="coge-import" class="sub-section">
                <div class="import-card">
                    <i class="fas fa-file-excel"></i>
                    <h4>Formato tracciato record</h4>
                    <p>Data | Descrizione | Conto Dare | Conto Avere | Importo</p>
                    <input type="file" id="cogeExcelInput" accept=".csv" style="display: none;" onchange="handleExcelCOGE(this.files[0])">
                    <button class="btn" onclick="document.getElementById('cogeExcelInput').click()"><i class="fas fa-upload"></i> Seleziona CSV</button>
                    <div id="cogeExcelPreview" class="preview-area">Nessun file selezionato</div>
                </div>
                
                <div id="cogeExcelDettaglio" style="display: none;">
                    <div style="background: #f8f8fa; padding: 20px; border-radius: 16px;">
                        <h4>Anteprima scritture</h4>
                        <div id="cogeExcelAnteprima"></div>
                        <div class="flex" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="confermaImportExcelCOGE()">Conferma</button>
                            <button class="btn btn-secondary" onclick="annullaImportExcelCOGE()">Annulla</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Elenco Scritture -->
            <div id="coge-lista" class="sub-section">
                <table>
                    <thead><tr><th>Data</th><th>Descrizione</th><th>Dare</th><th>Avere</th><th>Importo</th></tr></thead>
                    <tbody id="tabellaScrittureCOGE"></tbody>
                </table>
            </div>
        </div>

        <!-- LIQUIDAZIONE IVA -->
        <div id="iva-view" class="section" style="display: none;">
            <h2><i class="fas fa-percent"></i> Liquidazione IVA</h2>
            
            <div class="report-periodo">
                <div class="form-group"><label>Dal</label><input type="date" id="ivaDal" class="form-control"></div>
                <div class="form-group"><label>Al</label><input type="date" id="ivaAl" class="form-control"></div>
                <div><button class="btn btn-success" onclick="calcolaLiquidazioneIVA()"><i class="fas fa-calculator"></i> Calcola</button></div>
            </div>
            
            <div id="ivaRisultato" style="display: none;">
                <div style="background: #f8f8fa; padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                    <h3>Riepilogo IVA</h3>
                    <table>
                        <thead><tr><th>Codice</th><th>Aliquota</th><th>Imponibile Vendite</th><th>IVA Vendite</th><th>Imponibile Acquisti</th><th>IVA Acquisti</th></tr></thead>
                        <tbody id="ivaRiepilogoBody"></tbody>
                        <tfoot id="ivaRiepilogoFoot"></tfoot>
                    </table>
                </div>
                
                <div style="background: #e5f3ff; padding: 20px; border-radius: 16px; text-align: center;">
                    <h4>IVA a debito/credito</h4>
                    <h2 id="ivaNettoPeriodo" style="font-size: 2.5rem; color: #007aff;">€ 0,00</h2>
                    <div class="flex" style="justify-content: center;">
                        <button class="btn btn-success" onclick="registraLiquidazioneIVA()">Registra Liquidazione</button>
                        <button class="btn btn-secondary" onclick="stampaLiquidazioneIVA()">Stampa</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- IMPORT BANCARIO -->
        <div id="bancario-view" class="section" style="display: none;">
            <h2><i class="fas fa-university"></i> Importazioni Bancarie</h2>
            
            <div class="sub-tabs">
                <div class="sub-tab active" onclick="cambiaSubTab('bancario', 'import')">Importa Movimenti</div>
                <div class="sub-tab" onclick="cambiaSubTab('bancario', 'riconciliazione')">Riconciliazione</div>
                <div class="sub-tab" onclick="cambiaSubTab('bancario', 'partite')">Partite Aperte</div>
            </div>
            
            <!-- Import Movimenti -->
            <div id="bancario-import" class="sub-section active">
                <div class="import-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                    <div class="import-card">
                        <i class="fas fa-file-csv"></i>
                        <h4>Formato CBI / CSV</h4>
                        <input type="file" id="bancarioCsvInput" accept=".csv" style="display: none;" onchange="handleBancarioCSV(this.files[0])">
                        <button class="btn" onclick="document.getElementById('bancarioCsvInput').click()">Seleziona CSV</button>
                    </div>
                </div>
                
                <div id="bancarioPreview" style="display: none; margin-top: 20px;">
                    <div style="background: #f8f8fa; padding: 20px; border-radius: 16px;">
                        <h4>Movimenti importati</h4>
                        <div id="bancarioTabella"></div>
                        <div class="flex"><button class="btn btn-success" onclick="confermaImportBancario()">Conferma</button><button class="btn btn-secondary" onclick="annullaImportBancario()">Annulla</button></div>
                    </div>
                </div>
            </div>
            
            <!-- Riconciliazione -->
            <div id="bancario-riconciliazione" class="sub-section">
                <p>Seleziona un movimento bancario e una fattura per riconciliare</p>
                <div id="riconciliazioneContainer" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div><h4>Movimenti Bancari</h4><div id="movimentiBancariList"></div></div>
                    <div><h4>Fatture da Pagare/Incassare</h4><div id="partiteDaRiconciliareList"></div></div>
                </div>
            </div>
            
            <!-- Partite Aperte -->
            <div id="bancario-partite" class="sub-section">
                <div class="sub-tabs" style="margin-bottom: 15px;">
                    <div class="sub-tab active" onclick="cambiaSubSubTab('partite', 'fornitori')">Fornitori</div>
                    <div class="sub-tab" onclick="cambiaSubSubTab('partite', 'clienti')">Clienti</div>
                </div>
                
                <div id="partite-fornitori" class="sub-section active">
                    <table><thead><tr><th>Fornitore</th><th>Fattura</th><th>Data</th><th>Importo</th><th>Residuo</th><th>Azioni</th></tr></thead><tbody id="partiteFornitoriBody"></tbody></table>
                </div>
                
                <div id="partite-clienti" class="sub-section">
                    <table><thead><tr><th>Cliente</th><th>Fattura</th><th>Data</th><th>Importo</th><th>Residuo</th><th>Azioni</th></tr></thead><tbody id="partiteClientiBody"></tbody></table>
                </div>
            </div>
        </div>

        <!-- BILANCIO -->
        <div id="bilancio-view" class="section" style="display: none;">
            <h2><i class="fas fa-print"></i> Stampa Bilancio</h2>
            
            <div class="report-periodo">
                <div class="form-group"><label>Dal</label><input type="date" id="bilancioDal" class="form-control"></div>
                <div class="form-group"><label>Al</label><input type="date" id="bilancioAl" class="form-control"></div>
                <div><button class="btn btn-success" onclick="generaBilancio()"><i class="fas fa-file-pdf"></i> Genera</button></div>
                <div><button class="btn btn-secondary" onclick="stampaBilancio()"><i class="fas fa-print"></i> Stampa</button></div>
            </div>
            
            <div id="bilancioContainer" style="background: white; padding: 30px; border-radius: 16px; border: 1px solid #e5e5ea;">
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3>BILANCIO D'ESERCIZIO</h3>
                    <p id="bilancioPeriodo">Periodo: Selezionare un intervallo</p>
                </div>
                <div id="bilancioContenuto"></div>
            </div>
        </div>
    </div>

    <!-- MODALI -->
    <div id="modalNuovaCategoria" class="modal">
        <div class="modal-content"><h3>Nuova Categoria</h3>
            <div class="form-group"><label>Sezione</label><select id="catSezione" class="form-control"><option value="attivo">ATTIVO</option><option value="passivo">PASSIVO</option><option value="patrimonioNetto">PATRIMONIO NETTO</option><option value="costi">COSTI</option><option value="ricavi">RICAVI</option></select></div>
            <div class="form-group"><label>Nome Categoria</label><input type="text" id="catNome" class="form-control"></div>
            <div class="form-group"><label>Codice</label><input type="text" id="catCodice" class="form-control"></div>
            <div class="flex"><button class="btn btn-success" onclick="salvaNuovaCategoria()">Salva</button><button class="btn btn-secondary" onclick="chiudiModal()">Annulla</button></div>
        </div>
    </div>

    <div id="modalNuovaSottocategoria" class="modal">
        <div class="modal-content"><h3>Nuova Sottocategoria</h3>
            <div class="form-group"><label>Categoria</label><select id="subCategoria" class="form-control"></select></div>
            <div class="form-group"><label>Nome Sottocategoria</label><input type="text" id="subNome" class="form-control"></div>
            <div class="form-group"><label>Codice</label><input type="text" id="subCodice" class="form-control"></div>
            <div class="flex"><button class="btn btn-success" onclick="salvaNuovaSottocategoria()">Salva</button><button class="btn btn-secondary" onclick="chiudiModal()">Annulla</button></div>
        </div>
    </div>

    <div id="modalNuovoConto" class="modal">
        <div class="modal-content"><h3>Nuovo Conto</h3>
            <div class="form-group"><label>Sottocategoria</label><select id="contoSottocategoria" class="form-control"></select></div>
            <div class="form-group"><label>Nome Conto</label><input type="text" id="contoNome" class="form-control"></div>
            <div class="form-group"><label>Codice</label><input type="text" id="contoCodice" class="form-control"></div>
            <div class="form-group"><label>Tipo</label><select id="contoTipo" class="form-control"><option value="generico">Generico</option><option value="fornitore">Fornitore</option><option value="cliente">Cliente</option><option value="banca">Banca</option></select></div>
            <div class="form-group"><label>Partita IVA</label><input type="text" id="contoPiva" class="form-control"></div>
            <div class="flex"><button class="btn btn-success" onclick="salvaNuovoConto()">Salva</button><button class="btn btn-secondary" onclick="chiudiModal()">Annulla</button></div>
        </div>
    </div>

    <div id="modalPagamento" class="modal">
        <div class="modal-content"><h3>Registra Pagamento</h3>
            <input type="hidden" id="pagamentoTipo"><input type="hidden" id="pagamentoId"><input type="hidden" id="pagamentoFornitoreId">
            <div class="form-group"><label>Data Pagamento</label><input type="date" id="pagamentoData" class="form-control"></div>
            <div class="form-group"><label>Importo da Pagare</label><input type="number" id="pagamentoImporto" class="form-control" readonly></div>
            <div class="form-group"><label>Importo Pagato</label><input type="number" id="pagamentoImportoPagato" class="form-control"></div>
            <div class="form-group"><label>Conto Bancario</label><select id="pagamentoConto" class="form-control"></select></div>
            <div class="flex"><button class="btn btn-success" onclick="confermaPagamento()">Registra</button><button class="btn btn-secondary" onclick="chiudiModalPagamento()">Annulla</button></div>
        </div>
    </div>

    <script>
        // ============================================
        // DATI COMPLETI
        // ============================================
        
        let categorie = [
            { id: 'c1', sezione: 'attivo', nome: 'Disponibilità liquide', codice: '10' },
            { id: 'c2', sezione: 'attivo', nome: 'Crediti', codice: '11' },
            { id: 'c3', sezione: 'attivo', nome: 'Immobilizzazioni materiali', codice: '12' },
            { id: 'c4', sezione: 'passivo', nome: 'Debiti verso fornitori', codice: '20' },
            { id: 'c5', sezione: 'passivo', nome: 'Debiti tributari', codice: '21' },
            { id: 'c6', sezione: 'costi', nome: 'Materie prime', codice: '40' },
            { id: 'c7', sezione: 'costi', nome: 'Servizi', codice: '41' },
            { id: 'c8', sezione: 'ricavi', nome: 'Vendite', codice: '50' }
        ];
        
        let sottocategorie = [
            { id: 's1', categoriaId: 'c1', nome: 'Banche c/c', codice: '10.01' },
            { id: 's2', categoriaId: 'c1', nome: 'Cassa', codice: '10.02' },
            { id: 's3', categoriaId: 'c2', nome: 'Crediti v/clienti', codice: '11.01' },
            { id: 's4', categoriaId: 'c4', nome: 'Fornitori', codice: '20.01' },
            { id: 's5', categoriaId: 'c5', nome: 'IVA a debito', codice: '21.01' },
            { id: 's6', categoriaId: 'c5', nome: 'IVA a credito', codice: '21.02' },
            { id: 's7', categoriaId: 'c5', nome: 'Erario c/IVA', codice: '21.03' },
            { id: 's8', categoriaId: 'c6', nome: 'Acquisto merci', codice: '40.01' },
            { id: 's9', categoriaId: 'c7', nome: 'Consulenze', codice: '41.01' },
            { id: 's10', categoriaId: 'c8', nome: 'Vendita merci', codice: '50.01' }
        ];
        
        let conti = [
            { id: 'ct1', sottocategoriaId: 's1', nome: 'Banca Intesa', codice: '10.01.001', tipo: 'banca', piva: '' },
            { id: 'ct2', sottocategoriaId: 's1', nome: 'Banca Unicredit', codice: '10.01.002', tipo: 'banca', piva: '' },
            { id: 'ct3', sottocategoriaId: 's4', nome: 'Fornitore Rossi', codice: '20.01.001', tipo: 'fornitore', piva: '12345678901' },
            { id: 'ct4', sottocategoriaId: 's4', nome: 'Fornitore Bianchi', codice: '20.01.002', tipo: 'fornitore', piva: '98765432109' },
            { id: 'ct5', sottocategoriaId: 's8', nome: 'Acquisto merci', codice: '40.01.001', tipo: 'generico', piva: '' },
            { id: 'ct6', sottocategoriaId: 's9', nome: 'Consulenze tecniche', codice: '41.01.001', tipo: 'generico', piva: '' },
            { id: 'ct7', sottocategoriaId: 's10', nome: 'Vendita prodotti', codice: '50.01.001', tipo: 'generico', piva: '' },
            { id: 'ct8', sottocategoriaId: 's5', nome: 'IVA a debito 22%', codice: '21.01.001', tipo: 'generico', piva: '' },
            { id: 'ct9', sottocategoriaId: 's6', nome: 'IVA a credito 22%', codice: '21.02.001', tipo: 'generico', piva: '' },
            { id: 'ct10', sottocategoriaId: 's7', nome: 'Erario c/IVA', codice: '21.03.001', tipo: 'generico', piva: '' }
        ];
        
        let fatture = [];
        let scritture = [];
        let pagamenti = [];
        let movimentiBancari = [];
        
        // ============================================
        // FUNZIONI TAB
        // ============================================
        
        function cambiaTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
            document.getElementById(tab + '-view').style.display = 'block';
            
            if (tab === 'conti') visualizzaPianoConti();
            if (tab === 'passive') { aggiornaListaFatturePassive(); popolaDropdownContiCosto(); }
            if (tab === 'attive') { aggiornaListaFattureAttive(); popolaDropdownContiRicavo(); }
            if (tab === 'coge') { popolaDropdownContiCOGE(); aggiornaListaScritture(); }
            if (tab === 'bancario') { aggiornaPartite(); aggiornaMovimentiBancari(); popolaContiBancari(); }
            if (tab === 'dashboard') aggiornaDashboard();
        }
        
        function cambiaSubTab(mainTab, subTab) {
            document.querySelectorAll(`#${mainTab}-view .sub-tab`).forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`#${mainTab}-view .sub-section`).forEach(s => s.style.display = 'none');
            document.querySelector(`#${mainTab}-view .sub-tab[onclick*="${subTab}"]`).classList.add('active');
            document.getElementById(`${mainTab}-${subTab}`).style.display = 'block';
        }
        
        function cambiaSubSubTab(mainTab, subTab) {
            document.querySelectorAll(`#bancario-${mainTab} .sub-tab`).forEach(t => t.classList.remove('active'));
            document.querySelectorAll(`#bancario-${mainTab} .sub-section`).forEach(s => s.style.display = 'none');
            document.getElementById(`${mainTab}-${subTab}`).style.display = 'block';
        }
        
        // ============================================
        // PIANO DEI CONTI
        // ============================================
        
        function visualizzaPianoConti() {
            const container = document.getElementById('pianoContiContainer');
            if (!container) return;
            
            let html = '';
            const sezioni = { attivo: 'ATTIVO', passivo: 'PASSIVO', patrimonioNetto: 'PATRIMONIO NETTO', costi: 'COSTI', ricavi: 'RICAVI' };
            
            Object.keys(sezioni).forEach(sezioneKey => {
                const catSezione = categorie.filter(c => c.sezione === sezioneKey);
                if (catSezione.length === 0) return;
                
                html += `<div class="sezione" data-sezione="${sezioneKey}">`;
                html += `<div class="sezione-header"><div class="sezione-titolo"><h3>${sezioni[sezioneKey]}</h3><span class="sezione-codice">${sezioneKey === 'attivo' ? '1' : sezioneKey === 'passivo' ? '2' : sezioneKey === 'patrimonioNetto' ? '3' : sezioneKey === 'costi' ? '4' : '5'}</span></div><span class="sezione-totale" id="sezione_${sezioneKey}_totale">€ 0,00</span></div>`;
                html += `<div class="categorie-container">`;
                
                catSezione.forEach(cat => {
                    html += `<div class="categoria">`;
                    html += `<div class="categoria-header"><div class="categoria-info"><h4>${cat.nome}</h4><span class="categoria-codice">${cat.codice}</span><i class="fas fa-edit edit-conto" onclick="modificaStruttura('categoria','${cat.id}','${cat.nome}','${cat.codice}')"></i></div><span class="categoria-totale" id="categoria_${cat.id}_totale">€ 0,00</span></div>`;
                    
                    const subCat = sottocategorie.filter(s => s.categoriaId === cat.id);
                    if (subCat.length > 0) {
                        html += `<div class="sottocategorie-container">`;
                        subCat.forEach(sub => {
                            html += `<div class="sottocategoria">`;
                            html += `<div class="sottocategoria-header"><div class="sottocategoria-info"><h5>${sub.nome}</h5><span class="sottocategoria-codice">${sub.codice}</span><i class="fas fa-edit edit-conto" onclick="modificaStruttura('sottocategoria','${sub.id}','${sub.nome}','${sub.codice}')"></i></div><span class="sottocategoria-totale" id="sottocategoria_${sub.id}_totale">€ 0,00</span></div>`;
                            
                            const contiSub = conti.filter(c => c.sottocategoriaId === sub.id);
                            if (contiSub.length > 0) {
                                html += `<ul class="conti-lista">`;
                                contiSub.forEach(conto => {
                                    html += `<li><div class="conto-info"><span class="conto-codice">${conto.codice}</span><span class="conto-nome">${conto.nome}</span><i class="fas fa-edit edit-conto" onclick="modificaStruttura('conto','${conto.id}','${conto.nome}','${conto.codice}')"></i></div><span class="conto-valore" id="conto_${conto.id}">€ 0,00</span></li>`;
                                });
                                html += `</ul>`;
                            }
                            html += `</div>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                });
                
                html += `</div></div>`;
            });
            
            container.innerHTML = html;
            aggiornaSaldiConti();
        }
        
        function aggiornaSaldiConti() {
            // Reset saldi
            conti.forEach(c => c.saldo = 0);
            
            // Calcola saldi da fatture
            fatture.forEach(f => {
                if (f.tipo === 'passiva') {
                    let contoFornitore = conti.find(c => c.id === f.fornitoreId);
                    let contoCosto = conti.find(c => c.id === f.contoId);
                    let contoIva = conti.find(c => c.codice === '21.02.001');
                    
                    if (contoFornitore) contoFornitore.saldo += (f.imponibile + f.iva);
                    if (contoCosto) contoCosto.saldo += f.imponibile;
                    if (contoIva) contoIva.saldo += f.iva;
                } else if (f.tipo === 'attiva') {
                    let contoCrediti = conti.find(c => c.codice === '11.01.001');
                    let contoRicavo = conti.find(c => c.id === f.contoId);
                    let contoIva = conti.find(c => c.codice === '21.01.001');
                    
                    if (contoCrediti) contoCrediti.saldo += (f.imponibile + f.iva);
                    if (contoRicavo) contoRicavo.saldo += f.imponibile;
                    if (contoIva) contoIva.saldo += f.iva;
                }
            });
            
            // Calcola saldi da pagamenti
            pagamenti.forEach(p => {
                let contoBanca = conti.find(c => c.id === p.contoId);
                if (p.tipo === 'pagamentoFornitore') {
                    let contoFornitore = conti.find(c => c.id === p.fornitoreId);
                    if (contoFornitore) contoFornitore.saldo -= p.importo;
                    if (contoBanca) contoBanca.saldo -= p.importo;
                } else if (p.tipo === 'incassoCliente') {
                    let contoCrediti = conti.find(c => c.codice === '11.01.001');
                    if (contoCrediti) contoCrediti.saldo -= p.importo;
                    if (contoBanca) contoBanca.saldo += p.importo;
                }
            });
            
            // Calcola saldi da scritture COGE
            scritture.forEach(s => {
                let contoDare = conti.find(c => c.id === s.dareId);
                let contoAvere = conti.find(c => c.id === s.avereId);
                if (contoDare) contoDare.saldo += s.importo;
                if (contoAvere) contoAvere.saldo -= s.importo;
            });
            
            // Aggiorna UI
            conti.forEach(c => {
                let el = document.getElementById(`conto_${c.id}`);
                if (el) el.textContent = `€ ${(c.saldo || 0).toFixed(2)}`;
            });
            
            sottocategorie.forEach(s => {
                let totale = conti.filter(c => c.sottocategoriaId === s.id).reduce((sum, c) => sum + (c.saldo || 0), 0);
                let el = document.getElementById(`sottocategoria_${s.id}_totale`);
                if (el) el.textContent = `€ ${totale.toFixed(2)}`;
            });
            
            categorie.forEach(cat => {
                let subs = sottocategorie.filter(s => s.categoriaId === cat.id);
                let totale = 0;
                subs.forEach(s => {
                    totale += conti.filter(c => c.sottocategoriaId === s.id).reduce((sum, c) => sum + (c.saldo || 0), 0);
                });
                let el = document.getElementById(`categoria_${cat.id}_totale`);
                if (el) el.textContent = `€ ${totale.toFixed(2)}`;
            });
            
            ['attivo', 'passivo', 'patrimonioNetto', 'costi', 'ricavi'].forEach(sez => {
                let catSez = categorie.filter(c => c.sezione === sez);
                let totale = 0;
                catSez.forEach(cat => {
                    let subs = sottocategorie.filter(s => s.categoriaId === cat.id);
                    subs.forEach(s => {
                        totale += conti.filter(c => c.sottocategoriaId === s.id).reduce((sum, c) => sum + (c.saldo || 0), 0);
                    });
                });
                let el = document.getElementById(`sezione_${sez}_totale`);
                if (el) el.textContent = `€ ${totale.toFixed(2)}`;
            });
        }
        
        function modificaStruttura(tipo, id, nome, codice) {
            alert(`Modifica ${tipo}: ${nome} (${codice})`);
        }
        
        // ============================================
        // FUNZIONI MODAL
        // ============================================
        
        function mostraModal(tipo) {
            if (tipo === 'categoria') {
                document.getElementById('modalNuovaCategoria').classList.add('active');
            } else if (tipo === 'sottocategoria') {
                let select = document.getElementById('subCategoria');
                select.innerHTML = '';
                categorie.forEach(c => select.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
                document.getElementById('modalNuovaSottocategoria').classList.add('active');
            } else if (tipo === 'conto') {
                let select = document.getElementById('contoSottocategoria');
                select.innerHTML = '';
                sottocategorie.forEach(s => select.innerHTML += `<option value="${s.id}">${s.nome}</option>`);
                document.getElementById('modalNuovoConto').classList.add('active');
            }
        }
        
        function chiudiModal() {
            document.getElementById('modalNuovaCategoria').classList.remove('active');
            document.getElementById('modalNuovaSottocategoria').classList.remove('active');
            document.getElementById('modalNuovoConto').classList.remove('active');
            document.getElementById('modalPagamento').classList.remove('active');
        }
        
        function salvaNuovaCategoria() {
            categorie.push({
                id: 'c' + Date.now(),
                sezione: document.getElementById('catSezione').value,
                nome: document.getElementById('catNome').value,
                codice: document.getElementById('catCodice').value
            });
            chiudiModal();
            visualizzaPianoConti();
        }
        
        function salvaNuovaSottocategoria() {
            sottocategorie.push({
                id: 's' + Date.now(),
                categoriaId: document.getElementById('subCategoria').value,
                nome: document.getElementById('subNome').value,
                codice: document.getElementById('subCodice').value
            });
            chiudiModal();
            visualizzaPianoConti();
        }
        
        function salvaNuovoConto() {
            conti.push({
                id: 'ct' + Date.now(),
                sottocategoriaId: document.getElementById('contoSottocategoria').value,
                nome: document.getElementById('contoNome').value,
                codice: document.getElementById('contoCodice').value,
                tipo: document.getElementById('contoTipo').value,
                piva: document.getElementById('contoPiva').value
            });
            chiudiModal();
            visualizzaPianoConti();
            popolaDropdownContiCosto();
            popolaDropdownContiRicavo();
            popolaDropdownContiCOGE();
            popolaContiBancari();
        }
        
        function resetContiDefault() {
            if (confirm('Tornare ai conti predefiniti?')) location.reload();
        }
        
        // ============================================
        // FUNZIONI FATTURE PASSIVE
        // ============================================
        
        function popolaDropdownContiCosto() {
            let select = document.getElementById('passConto');
            if (!select) return;
            select.innerHTML = '<option value="">Seleziona...</option>';
            conti.filter(c => {
                let sub = sottocategorie.find(s => s.id === c.sottocategoriaId);
                let cat = categorie.find(ca => ca.id === sub?.categoriaId);
                return cat?.sezione === 'costi';
            }).forEach(c => select.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
        }
        
        function cercaFornitoreDaPiva() {
            let piva = document.getElementById('passPiva').value;
            let fornitore = conti.find(c => c.piva === piva && c.tipo === 'fornitore');
            if (fornitore) {
                document.getElementById('passFornitoreEsistente').style.display = 'block';
                document.getElementById('passFornitoreNome').textContent = fornitore.nome;
                document.getElementById('passFornitore').value = fornitore.nome;
            } else {
                document.getElementById('passFornitoreEsistente').style.display = 'none';
            }
        }
        
        function cercaFornitoreDaCf() {
            let cf = document.getElementById('passCf').value;
            let fornitore = conti.find(c => c.piva === cf || c.cf === cf);
            if (fornitore) {
                document.getElementById('passFornitoreEsistente').style.display = 'block';
                document.getElementById('passFornitoreNome').textContent = fornitore.nome;
            }
        }
        
        function resetFormPassiva() {
            document.getElementById('passNumero').value = '';
            document.getElementById('passData').value = new Date().toISOString().split('T')[0];
            document.getElementById('passFornitore').value = '';
            document.getElementById('passPiva').value = '';
            document.getElementById('passCf').value = '';
            document.getElementById('passImponibile').value = '';
            document.getElementById('passFornitoreEsistente').style.display = 'none';
        }
        
        function inserisciFatturaPassiva() {
            let numero = document.getElementById('passNumero').value;
            let data = document.getElementById('passData').value;
            let fornitore = document.getElementById('passFornitore').value;
            let piva = document.getElementById('passPiva').value;
            let imponibile = parseFloat(document.getElementById('passImponibile').value);
            let aliquota = parseFloat(document.getElementById('passAliquota').value) / 100;
            let contoId = document.getElementById('passConto').value;
            
            if (!numero || !data || !fornitore || !imponibile || !contoId) {
                alert('Compila tutti i campi obbligatori');
                return;
            }
            
            let iva = imponibile * aliquota;
            
            // Cerca o crea conto fornitore
            let contoFornitore = conti.find(c => c.piva === piva && c.tipo === 'fornitore');
            if (!contoFornitore && piva) {
                let subFornitori = sottocategorie.find(s => s.nome === 'Fornitori');
                if (subFornitori) {
                    contoFornitore = {
                        id: 'ct' + Date.now(),
                        sottocategoriaId: subFornitori.id,
                        nome: fornitore,
                        codice: '20.01.' + Math.floor(100 + Math.random() * 900),
                        tipo: 'fornitore',
                        piva: piva
                    };
                    conti.push(contoFornitore);
                }
            }
            
            fatture.push({
                id: Date.now(),
                tipo: 'passiva',
                numero, data, fornitore, piva,
                imponibile, iva, aliquota,
                contoId,
                fornitoreId: contoFornitore?.id
            });
            
            resetFormPassiva();
            aggiornaListaFatturePassive();
            aggiornaSaldiConti();
            aggiornaDashboard();
            alert('Fattura salvata!');
        }
        
        function aggiornaListaFatturePassive() {
            let tbody = document.getElementById('tabellaFatturePassive');
            if (!tbody) return;
            tbody.innerHTML = '';
            let passive = fatture.filter(f => f.tipo === 'passiva');
            if (passive.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nessuna fattura</td></tr>';
                return;
            }
            passive.forEach(f => {
                let totale = f.imponibile + f.iva;
                let pagato = pagamenti.filter(p => p.fatturaId === f.id).reduce((s, p) => s + p.importo, 0);
                let residuo = totale - pagato;
                tbody.innerHTML += `<tr>
                    <td>${f.data}</td><td>${f.fornitore}</td><td>${f.piva || '-'}</td>
                    <td>€ ${f.imponibile.toFixed(2)}</td><td>€ ${f.iva.toFixed(2)}</td>
                    <td>€ ${totale.toFixed(2)}</td>
                    <td>${residuo <= 0 ? '<span class="badge-success">Pagato</span>' : '<span class="badge-warning">€ ' + residuo.toFixed(2) + '</span>'}</td>
                    <td><button class="btn-icon" onclick="apriPagamento('fornitore','${f.id}','${f.fornitoreId}',${residuo})"><i class="fas fa-euro-sign"></i></button></td>
                </tr>`;
            });
        }
        
        // ============================================
        // FUNZIONI FATTURE ATTIVE
        // ============================================
        
        function popolaDropdownContiRicavo() {
            let select = document.getElementById('attConto');
            if (!select) return;
            select.innerHTML = '<option value="">Seleziona...</option>';
            conti.filter(c => {
                let sub = sottocategorie.find(s => s.id === c.sottocategoriaId);
                let cat = categorie.find(ca => ca.id === sub?.categoriaId);
                return cat?.sezione === 'ricavi';
            }).forEach(c => select.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
        }
        
        function resetFormAttiva() {
            document.getElementById('attNumero').value = '';
            document.getElementById('attData').value = new Date().toISOString().split('T')[0];
            document.getElementById('attCliente').value = '';
            document.getElementById('attPiva').value = '';
            document.getElementById('attImponibile').value = '';
        }
        
        function inserisciFatturaAttiva() {
            let numero = document.getElementById('attNumero').value;
            let data = document.getElementById('attData').value;
            let cliente = document.getElementById('attCliente').value;
            let piva = document.getElementById('attPiva').value;
            let imponibile = parseFloat(document.getElementById('attImponibile').value);
            let aliquota = parseFloat(document.getElementById('attAliquota').value) / 100;
            let contoId = document.getElementById('attConto').value;
            
            if (!numero || !data || !cliente || !imponibile || !contoId) {
                alert('Compila tutti i campi obbligatori');
                return;
            }
            
            let iva = imponibile * aliquota;
            
            fatture.push({
                id: Date.now(),
                tipo: 'attiva',
                numero, data, fornitore: cliente, piva,
                imponibile, iva, aliquota,
                contoId
            });
            
            resetFormAttiva();
            aggiornaListaFattureAttive();
            aggiornaSaldiConti();
            aggiornaDashboard();
            alert('Fattura salvata!');
        }
        
        function aggiornaListaFattureAttive() {
            let tbody = document.getElementById('tabellaFattureAttive');
            if (!tbody) return;
            tbody.innerHTML = '';
            let attive = fatture.filter(f => f.tipo === 'attiva');
            if (attive.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Nessuna fattura</td></tr>';
                return;
            }
            attive.forEach(f => {
                let totale = f.imponibile + f.iva;
                let pagato = pagamenti.filter(p => p.fatturaId === f.id).reduce((s, p) => s + p.importo, 0);
                let residuo = totale - pagato;
                tbody.innerHTML += `<tr>
                    <td>${f.data}</td><td>${f.fornitore}</td><td>${f.piva || '-'}</td>
                    <td>€ ${f.imponibile.toFixed(2)}</td><td>€ ${f.iva.toFixed(2)}</td>
                    <td>€ ${totale.toFixed(2)}</td>
                    <td>${residuo <= 0 ? '<span class="badge-success">Incassato</span>' : '<span class="badge-warning">€ ' + residuo.toFixed(2) + '</span>'}</td>
                    <td><button class="btn-icon" onclick="apriPagamento('cliente','${f.id}','',${residuo})"><i class="fas fa-euro-sign"></i></button></td>
                </tr>`;
            });
        }
        
        // ============================================
        // FUNZIONI PAGAMENTO
        // ============================================
        
        function apriPagamento(tipo, fatturaId, fornitoreId, importo) {
            document.getElementById('pagamentoTipo').value = tipo;
            document.getElementById('pagamentoId').value = fatturaId;
            document.getElementById('pagamentoFornitoreId').value = fornitoreId || '';
            document.getElementById('pagamentoImporto').value = importo.toFixed(2);
            document.getElementById('pagamentoImportoPagato').value = importo.toFixed(2);
            document.getElementById('pagamentoData').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalPagamento').classList.add('active');
        }
        
        function confermaPagamento() {
            let tipo = document.getElementById('pagamentoTipo').value;
            let fatturaId = document.getElementById('pagamentoId').value;
            let fornitoreId = document.getElementById('pagamentoFornitoreId').value;
            let data = document.getElementById('pagamentoData').value;
            let importo = parseFloat(document.getElementById('pagamentoImportoPagato').value);
            let contoId = document.getElementById('pagamentoConto').value;
            
            if (!data || !importo || !contoId) {
                alert('Compila tutti i campi');
                return;
            }
            
            pagamenti.push({
                id: Date.now(),
                tipo: tipo === 'fornitore' ? 'pagamentoFornitore' : 'incassoCliente',
                fatturaId,
                fornitoreId,
                data,
                importo,
                contoId
            });
            
            chiudiModal();
            aggiornaListaFatturePassive();
            aggiornaListaFattureAttive();
            aggiornaSaldiConti();
            aggiornaDashboard();
            alert('Pagamento registrato!');
        }
        
        function chiudiModalPagamento() {
            document.getElementById('modalPagamento').classList.remove('active');
        }
        
        // ============================================
        // FUNZIONI IMPORT XML
        // ============================================
        
        function handleXMLPassive(file) {
            let reader = new FileReader();
            reader.onload = function(e) {
                let xml = e.target.result;
                let parser = new DOMParser();
                let xmlDoc = parser.parseFromString(xml, 'text/xml');
                
                let numero = xmlDoc.querySelector('Numero')?.textContent || 'N/D';
                let data = xmlDoc.querySelector('Data')?.textContent || new Date().toISOString().split('T')[0];
                let denominazione = xmlDoc.querySelector('Denominazione')?.textContent || '';
                let piva = (xmlDoc.querySelector('IdPaese')?.textContent || '') + (xmlDoc.querySelector('IdCodice')?.textContent || '');
                
                document.getElementById('passXmlPreview').innerHTML = `Fattura ${numero} - ${denominazione}`;
                
                let fornitoreEsistente = conti.find(c => c.piva === piva);
                let msg = fornitoreEsistente ? `✅ Fornitore esistente: ${fornitoreEsistente.nome}` : `➕ Nuovo fornitore: ${denominazione}`;
                document.getElementById('passXmlFornitoreInfo').innerHTML = msg;
                
                document.getElementById('passXmlDettaglio').style.display = 'block';
            };
            reader.readAsText(file);
        }
        
        function confermaImportXMLPassive() {
            alert('Import completato!');
            annullaImportXMLPassive();
        }
        
        function annullaImportXMLPassive() {
            document.getElementById('passXmlDettaglio').style.display = 'none';
            document.getElementById('passXmlPreview').innerHTML = 'Nessun file selezionato';
            document.getElementById('passXmlInput').value = '';
        }
        
        function handleXMLAttive(file) {
            let reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('attXmlPreview').innerHTML = 'File caricato';
                document.getElementById('attXmlDettaglio').style.display = 'block';
            };
            reader.readAsText(file);
        }
        
        function confermaImportXMLAttive() {
            alert('Import completato!');
            annullaImportXMLAttive();
        }
        
        function annullaImportXMLAttive() {
            document.getElementById('attXmlDettaglio').style.display = 'none';
            document.getElementById('attXmlPreview').innerHTML = 'Nessun file selezionato';
            document.getElementById('attXmlInput').value = '';
        }
        
        // ============================================
        // FUNZIONI COGE
        // ============================================
        
        function popolaDropdownContiCOGE() {
            let dare = document.getElementById('cogeDare');
            let avere = document.getElementById('cogeAvere');
            if (!dare || !avere) return;
            
            let options = '<option value="">Seleziona...</option>';
            conti.forEach(c => options += `<option value="${c.id}">${c.codice} - ${c.nome}</option>`);
            dare.innerHTML = options;
            avere.innerHTML = options;
        }
        
        function resetFormCOGE() {
            document.getElementById('cogeData').value = new Date().toISOString().split('T')[0];
            document.getElementById('cogeDescrizione').value = '';
            document.getElementById('cogeDare').value = '';
            document.getElementById('cogeAvere').value = '';
            document.getElementById('cogeImporto').value = '';
        }
        
        function inserisciScritturaCOGE() {
            let data = document.getElementById('cogeData').value;
            let descrizione = document.getElementById('cogeDescrizione').value;
            let dareId = document.getElementById('cogeDare').value;
            let avereId = document.getElementById('cogeAvere').value;
            let importo = parseFloat(document.getElementById('cogeImporto').value);
            
            if (!data || !descrizione || !dareId || !avereId || !importo) {
                alert('Compila tutti i campi');
                return;
            }
            
            scritture.push({ id: Date.now(), data, descrizione, dareId, avereId, importo });
            resetFormCOGE();
            aggiornaListaScritture();
            aggiornaSaldiConti();
            alert('Scrittura salvata!');
        }
        
        function aggiornaListaScritture() {
            let tbody = document.getElementById('tabellaScrittureCOGE');
            if (!tbody) return;
            tbody.innerHTML = '';
            if (scritture.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Nessuna scrittura</td></tr>';
                return;
            }
            scritture.forEach(s => {
                let dare = conti.find(c => c.id === s.dareId);
                let avere = conti.find(c => c.id === s.avereId);
                tbody.innerHTML += `<tr><td>${s.data}</td><td>${s.descrizione}</td><td>${dare?.nome || ''}</td><td>${avere?.nome || ''}</td><td>€ ${s.importo.toFixed(2)}</td></tr>`;
            });
        }
        
        function handleExcelCOGE(file) {
            alert('Import Excel in sviluppo');
        }
        
        function confermaImportExcelCOGE() {
            alert('Import completato');
        }
        
        function annullaImportExcelCOGE() {
            document.getElementById('cogeExcelDettaglio').style.display = 'none';
        }
        
        // ============================================
        // FUNZIONI IVA
        // ============================================
        
        function calcolaLiquidazioneIVA() {
            let dal = document.getElementById('ivaDal').value;
            let al = document.getElementById('ivaAl').value;
            if (!dal || !al) { alert('Seleziona periodo'); return; }
            
            let fatturePeriodo = fatture.filter(f => f.data >= dal && f.data <= al);
            let ivaVendite = fatturePeriodo.filter(f => f.tipo === 'attiva').reduce((s, f) => s + f.iva, 0);
            let ivaAcquisti = fatturePeriodo.filter(f => f.tipo === 'passiva').reduce((s, f) => s + f.iva, 0);
            
            document.getElementById('ivaRiepilogoBody').innerHTML = `<tr><td>V1</td><td>22%</td><td>€ ${fatturePeriodo.filter(f => f.tipo === 'attiva').reduce((s, f) => s + f.imponibile, 0).toFixed(2)}</td><td>€ ${ivaVendite.toFixed(2)}</td><td>€ ${fatturePeriodo.filter(f => f.tipo === 'passiva').reduce((s, f) => s + f.imponibile, 0).toFixed(2)}</td><td>€ ${ivaAcquisti.toFixed(2)}</td></tr>`;
            document.getElementById('ivaRiepilogoFoot').innerHTML = `<tr><td colspan="3">TOTALI</td><td>€ ${ivaVendite.toFixed(2)}</td><td></td><td>€ ${ivaAcquisti.toFixed(2)}</td></tr>`;
            document.getElementById('ivaNettoPeriodo').textContent = `€ ${(ivaVendite - ivaAcquisti).toFixed(2)}`;
            document.getElementById('ivaRisultato').style.display = 'block';
        }
        
        function registraLiquidazioneIVA() {
            alert('Liquidazione registrata');
        }
        
        function stampaLiquidazioneIVA() {
            window.print();
        }
        
        // ============================================
        // FUNZIONI BANCARIO
        // ============================================
        
        function popolaContiBancari() {
            let select = document.getElementById('pagamentoConto');
            if (!select) return;
            select.innerHTML = '<option value="">Seleziona...</option>';
            conti.filter(c => c.tipo === 'banca').forEach(c => select.innerHTML += `<option value="${c.id}">${c.nome}</option>`);
        }
        
        function handleBancarioCSV(file) {
            let reader = new FileReader();
            reader.onload = function(e) {
                let lines = e.target.result.split('\n').filter(l => l.trim());
                let movimenti = [];
                for (let i = 1; i < lines.length; i++) {
                    let parts = lines[i].split(';');
                    if (parts.length >= 3) {
                        movimenti.push({
                            data: parts[0].replace(/\//g, '-'),
                            descrizione: parts[1],
                            importo: parseFloat(parts[2].replace(',', '.')) || 0
                        });
                    }
                }
                window.movimentiTemp = movimenti;
                
                let html = '<table><tr><th>Data</th><th>Descrizione</th><th>Importo</th></tr>';
                movimenti.slice(0, 10).forEach(m => html += `<tr><td>${m.data}</td><td>${m.descrizione}</td><td>€ ${Math.abs(m.importo).toFixed(2)}</td></tr>`);
                html += '</table>';
                document.getElementById('bancarioTabella').innerHTML = html;
                document.getElementById('bancarioPreview').style.display = 'block';
            };
            reader.readAsText(file);
        }
        
        function confermaImportBancario() {
            if (window.movimentiTemp) {
                movimentiBancari.push(...window.movimentiTemp);
                alert(`${window.movimentiTemp.length} movimenti importati`);
            }
            annullaImportBancario();
        }
        
        function annullaImportBancario() {
            document.getElementById('bancarioPreview').style.display = 'none';
            document.getElementById('bancarioCsvInput').value = '';
        }
        
        function aggiornaMovimentiBancari() {
            let list = document.getElementById('movimentiBancariList');
            if (!list) return;
            if (movimentiBancari.length === 0) {
                list.innerHTML = '<p class="empty-state">Nessun movimento</p>';
                return;
            }
            let html = '<table><tr><th>Data</th><th>Descrizione</th><th>Importo</th></tr>';
            movimentiBancari.slice(0, 10).forEach(m => html += `<tr><td>${m.data}</td><td>${m.descrizione}</td><td>€ ${Math.abs(m.importo).toFixed(2)}</td></tr>`);
            html += '</table>';
            list.innerHTML = html;
        }
        
        // ============================================
        // FUNZIONI PARTITE
        // ============================================
        
        function aggiornaPartite() {
            let fornBody = document.getElementById('partiteFornitoriBody');
            let cliBody = document.getElementById('partiteClientiBody');
            if (!fornBody || !cliBody) return;
            
            fornBody.innerHTML = '';
            cliBody.innerHTML = '';
            
            fatture.filter(f => f.tipo === 'passiva').forEach(f => {
                let totale = f.imponibile + f.iva;
                let pagato = pagamenti.filter(p => p.fatturaId === f.id).reduce((s, p) => s + p.importo, 0);
                let residuo = totale - pagato;
                if (residuo > 0.01) {
                    fornBody.innerHTML += `<tr class="partita"><td>${f.fornitore}</td><td>${f.numero}</td><td>${f.data}</td><td>€ ${totale.toFixed(2)}</td><td>€ ${residuo.toFixed(2)}</td><td><button class="btn-icon" onclick="apriPagamento('fornitore','${f.id}','${f.fornitoreId}',${residuo})"><i class="fas fa-check"></i></button></td></tr>`;
                }
            });
            
            fatture.filter(f => f.tipo === 'attiva').forEach(f => {
                let totale = f.imponibile + f.iva;
                let pagato = pagamenti.filter(p => p.fatturaId === f.id).reduce((s, p) => s + p.importo, 0);
                let residuo = totale - pagato;
                if (residuo > 0.01) {
                    cliBody.innerHTML += `<tr class="partita"><td>${f.fornitore}</td><td>${f.numero}</td><td>${f.data}</td><td>€ ${totale.toFixed(2)}</td><td>€ ${residuo.toFixed(2)}</td><td><button class="btn-icon" onclick="apriPagamento('cliente','${f.id}','',${residuo})"><i class="fas fa-check"></i></button></td></tr>`;
                }
            });
            
            document.getElementById('dashboardFornitoriAperti').textContent = `€ ${Array.from(document.querySelectorAll('#partiteFornitoriBody tr')).reduce((s, r) => s + parseFloat(r.cells[4]?.textContent.replace('€', '') || 0), 0).toFixed(2)}`;
            document.getElementById('dashboardClientiAperti').textContent = `€ ${Array.from(document.querySelectorAll('#partiteClientiBody tr')).reduce((s, r) => s + parseFloat(r.cells[4]?.textContent.replace('€', '') || 0), 0).toFixed(2)}`;
        }
        
        // ============================================
        // FUNZIONI BILANCIO
        // ============================================
        
        function generaBilancio() {
            let dal = document.getElementById('bilancioDal').value;
            let al = document.getElementById('bilancioAl').value;
            document.getElementById('bilancioPeriodo').innerHTML = `Periodo: ${dal} - ${al}`;
            
            let html = '<h4>Stato Patrimoniale</h4><table><tr><th>ATTIVO</th><th>Importo</th><th>PASSIVO</th><th>Importo</th></tr>';
            
            let attivi = conti.filter(c => {
                let sub = sottocategorie.find(s => s.id === c.sottocategoriaId);
                let cat = categorie.find(ca => ca.id === sub?.categoriaId);
                return cat?.sezione === 'attivo' && Math.abs(c.saldo || 0) > 0.01;
            });
            
            let passivi = conti.filter(c => {
                let sub = sottocategorie.find(s => s.id === c.sottocategoriaId);
                let cat = categorie.find(ca => ca.id === sub?.categoriaId);
                return cat?.sezione === 'passivo' && Math.abs(c.saldo || 0) > 0.01;
            });
            
            for (let i = 0; i < Math.max(attivi.length, passivi.length); i++) {
                html += '<tr>';
                if (i < attivi.length) html += `<td>${attivi[i].nome}</td><td>€ ${(attivi[i].saldo || 0).toFixed(2)}</td>`;
                else html += '<td></td><td></td>';
                if (i < passivi.length) html += `<td>${passivi[i].nome}</td><td>€ ${(passivi[i].saldo || 0).toFixed(2)}</td>`;
                else html += '<td></td><td></td>';
                html += '</tr>';
            }
            
            html += '</table><h4 style="margin-top:20px">Conto Economico</h4><table><tr><th>COSTI</th><th>Importo</th><th>RICAVI</th><th>Importo</th></tr>';
            
            let costi = conti.filter(c => {
                let sub = sottocategorie.find(s => s.id === c.sottocategoriaId);
                let cat = categorie.find(ca => ca.id === sub?.categoriaId);
                return cat?.sezione === 'costi' && Math.abs(c.saldo || 0) > 0.01;
            });
            
            let ricavi = conti.filter(c => {
                let sub = sottocategorie.find(s => s.id === c.sottocategoriaId);
                let cat = categorie.find(ca => ca.id === sub?.categoriaId);
                return cat?.sezione === 'ricavi' && Math.abs(c.saldo || 0) > 0.01;
            });
            
            for (let i = 0; i < Math.max(costi.length, ricavi.length); i++) {
                html += '<tr>';
                if (i < costi.length) html += `<td>${costi[i].nome}</td><td>€ ${(costi[i].saldo || 0).toFixed(2)}</td>`;
                else html += '<td></td><td></td>';
                if (i < ricavi.length) html += `<td>${ricavi[i].nome}</td><td>€ ${(ricavi[i].saldo || 0).toFixed(2)}</td>`;
                else html += '<td></td><td></td>';
                html += '</tr>';
            }
            
            html += '</table>';
            document.getElementById('bilancioContenuto').innerHTML = html;
        }
        
        function stampaBilancio() {
            window.print();
        }
        
        // ============================================
        // FUNZIONI DASHBOARD
        // ============================================
        
        function aggiornaDashboard() {
            let totaleAttivo = 0, totalePassivo = 0, totaleCosti = 0, totaleRicavi = 0;
            let ivaVendite = 0, ivaAcquisti = 0;
            
            conti.forEach(c => {
                let sub = sottocategorie.find(s => s.id === c.sottocategoriaId);
                let cat = categorie.find(ca => ca.id === sub?.categoriaId);
                if (!cat) return;
                if (cat.sezione === 'attivo') totaleAttivo += c.saldo || 0;
                else if (cat.sezione === 'passivo') totalePassivo += c.saldo || 0;
                else if (cat.sezione === 'costi') totaleCosti += c.saldo || 0;
                else if (cat.sezione === 'ricavi') totaleRicavi += c.saldo || 0;
                
                if (c.codice === '21.01.001') ivaVendite = c.saldo || 0;
                if (c.codice === '21.02.001') ivaAcquisti = c.saldo || 0;
            });
            
            document.getElementById('dashboardAttivo').textContent = `€ ${totaleAttivo.toFixed(2)}`;
            document.getElementById('dashboardPassivo').textContent = `€ ${totalePassivo.toFixed(2)}`;
            document.getElementById('dashboardNetto').textContent = `€ ${(totaleRicavi - totaleCosti).toFixed(2)}`;
            document.getElementById('dashboardIvaVendite').textContent = `€ ${ivaVendite.toFixed(2)}`;
            document.getElementById('dashboardIvaAcquisti').textContent = `€ ${ivaAcquisti.toFixed(2)}`;
            document.getElementById('dashboardIvaNetto').textContent = `€ ${(ivaVendite - ivaAcquisti).toFixed(2)}`;
        }
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('passData').value = new Date().toISOString().split('T')[0];
            document.getElementById('attData').value = new Date().toISOString().split('T')[0];
            document.getElementById('cogeData').value = new Date().toISOString().split('T')[0];
            document.getElementById('pagamentoData').value = new Date().toISOString().split('T')[0];
            
            let inizioAnno = new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0];
            let oggi = new Date().toISOString().split('T')[0];
            document.getElementById('ivaDal').value = inizioAnno;
            document.getElementById('ivaAl').value = oggi;
            document.getElementById('bilancioDal').value = inizioAnno;
            document.getElementById('bilancioAl').value = oggi;
            
            visualizzaPianoConti();
            popolaDropdownContiCosto();
            popolaDropdownContiRicavo();
            popolaDropdownContiCOGE();
            popolaContiBancari();
            aggiornaDashboard();
        });
        
        // Esponi funzioni globali
        window.cambiaTab = cambiaTab;
        window.cambiaSubTab = cambiaSubTab;
        window.cambiaSubSubTab = cambiaSubSubTab;
        window.mostraModal = mostraModal;
        window.chiudiModal = chiudiModal;
        window.salvaNuovaCategoria = salvaNuovaCategoria;
        window.salvaNuovaSottocategoria = salvaNuovaSottocategoria;
        window.salvaNuovoConto = salvaNuovoConto;
        window.resetContiDefault = resetContiDefault;
        window.modificaStruttura = modificaStruttura;
        window.cercaFornitoreDaPiva = cercaFornitoreDaPiva;
        window.cercaFornitoreDaCf = cercaFornitoreDaCf;
        window.resetFormPassiva = resetFormPassiva;
        window.inserisciFatturaPassiva = inserisciFatturaPassiva;
        window.resetFormAttiva = resetFormAttiva;
        window.inserisciFatturaAttiva = inserisciFatturaAttiva;
        window.resetFormCOGE = resetFormCOGE;
        window.inserisciScritturaCOGE = inserisciScritturaCOGE;
        window.handleXMLPassive = handleXMLPassive;
        window.confermaImportXMLPassive = confermaImportXMLPassive;
        window.annullaImportXMLPassive = annullaImportXMLPassive;
        window.handleXMLAttive = handleXMLAttive;
        window.confermaImportXMLAttive = confermaImportXMLAttive;
        window.annullaImportXMLAttive = annullaImportXMLAttive;
        window.handleExcelCOGE = handleExcelCOGE;
        window.confermaImportExcelCOGE = confermaImportExcelCOGE;
        window.annullaImportExcelCOGE = annullaImportExcelCOGE;
        window.handleBancarioCSV = handleBancarioCSV;
        window.confermaImportBancario = confermaImportBancario;
        window.annullaImportBancario = annullaImportBancario;
        window.apriPagamento = apriPagamento;
        window.confermaPagamento = confermaPagamento;
        window.chiudiModalPagamento = chiudiModalPagamento;
        window.calcolaLiquidazioneIVA = calcolaLiquidazioneIVA;
        window.registraLiquidazioneIVA = registraLiquidazioneIVA;
        window.stampaLiquidazioneIVA = stampaLiquidazioneIVA;
        window.generaBilancio = generaBilancio;
        window.stampaBilancio = stampaBilancio;
    </script>
</body>
</html>